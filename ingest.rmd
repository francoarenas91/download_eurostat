```{r}
rm(list = ls())

PAQUETES <- c("dplyr","tidyverse","ggplot2","eurostat","readxl")

for (el in PAQUETES){
  if (!require(el, character.only = TRUE)) {
    install.packages(el, repos = "https://cloud.r-project.org")
    require(el, character.only = TRUE)
  }
}
```

load country names, sheets, dictionary and create function to load and store data
```{r}
# Path to the dictionary file
file_path <- paste0("./dictionaries/","decoding_dict",".xlsx")

# Get a list of all sheet names
sheet_names <- excel_sheets(file_path)

# Load each dictionary sheet
dictionary_df <- lapply(sheet_names, function(sheet) {
  read_excel(file_path, sheet = sheet, col_types = c("code" = "text", "name" = "text"))
}) %>% bind_rows()
dictionary <- setNames(dictionary_df$name, dictionary_df$code)

#load EU country names
EU_countries<-read_excel("./dictionaries/EU_countries.xlsx") %>% 
  rename(country_code=code,country_name=name)
EU_Countries_names_dict<- setNames(EU_countries$country_name, EU_countries$country_code)

# Function to load and save country data
load_data_country <- function(series, alias, dictionary, sheet_names) {
  # Try to load data using get_eurostat
  data <- try(
    get_eurostat(series, filters = list(geo = pull(EU_countries, country_code))) %>%
      filter(!is.na(values)), # Filter out NAs
    silent = TRUE
  )

  # Check if an error occurred during get_eurostat call
  if (class(data) == "try-error") {
    message("Error in series code: ", series)
    return(NULL) # Exit the function on error
  }

  # Recode columns
  for (sheet in sheet_names) {
    if (sheet %in% colnames(data)) {
      data <- data %>%
        mutate(!!sym(sheet) := recode(!!sym(sheet), !!!dictionary))
      # !!! splits a vector into individual arguments for a function
      # !!sym() is a way to convert the string sheet into a symbol that dplyr can understand as a column name.
    }
  }

  # Save the data
  save(data, file = paste0("./data/country/", alias, ".RData"))
  print(paste0("series ", series, " ", alias, " loaded"))

  # Clean up
  rm(data)
  gc()
}

```

loading country data
```{r}
statistics<-read_excel("./loading_statistics.xlsx",sheet="country" )

for (ii in 1:nrow(statistics)) {
  load_data_country(statistics$code[ii],statistics$alias[ii],dictionary,sheet_names)
}
statistics$code[ii]

```
create geo and time table for the star schema in countries
```{r}
# List all files in the "./data" directory
data_files <- list.files("./data/country")

# Exclude "geo_dates" from the list
data_files <- data_files[data_files != "geo_dates.RData"]


geo_dates <- data.frame()
for (file in data_files) {
  load(paste0("./data/country/",file))
  print(file)
  data %>% 
    select(geo,time) %>%
    left_join(EU_countries,by=c("geo"="country_code")) %>% 
    rbind(geo_dates) %>% 
    unique() ->geo_dates
}
save(geo_dates, file = paste0("./data/country/","geo_dates", ".RData"))

```
funtion to load regional data
```{r}
load_data_region <- function(series,alias,dictionary,sheet_names){
  EU_countries<-read_excel("./dictionaries/EU_countries.xlsx") %>% 
  rename(country_code=code,country_name=name)
  #load data
  data <- get_eurostat(series) %>% 
    filter(!is.na(values)) %>%  #filter out NAs
    mutate(country_code=substr(geo,1,2)) %>% 
    filter(country_code %in% EU_countries$country_code) %>% 
    filter(nchar(geo)==4) %>% 
    select(-country_code) # in is in the date-country data
  #recode columns
  for (sheet in sheet_names){

    if (sheet %in% colnames(data)){
        data <- data %>% 
        mutate(!!sym(sheet) := recode(!!sym(sheet), !!!dictionary))
        ##!!! splits a vector into individual arguments for a function
        ## !!sym() is a way to convert the string sheet into a symbol that dplyr can understand as a column name.
    }
  }
  
  save(data, file = paste0("./data/region/",alias, ".RData"))
  print(paste0("series ",series," ", alias, " loaded"))
  rm(data)
  gc()
}
```

loading region data
```{r}
statistics<-read_excel("./loading_statistics.xlsx",sheet="region" )

for (ii in 1:nrow(statistics)) {
  load_data_region(statistics$code[ii],statistics$alias[ii],dictionary,sheet_names)
}

```
create geo and time table for the star schema in regions
```{r}
# List all files in the "./data" directory
data_files <- list.files("./data/region")

# Exclude "geo_dates" from the list
data_files <- data_files[data_files != "geo_dates.RData"]

NUTS2<-read_excel("./dictionaries/NUTS2.xlsx" ) %>% 
  rename(geo=NUTS2)

geo_dates <- data.frame()
for (file in data_files) {
  load(paste0("./data/region/",file))
  print(file)
  data %>% 
    select(geo,TIME_PERIOD) %>%
    left_join(NUTS2,by="geo") %>% 
    rbind(geo_dates) %>% 
    unique() ->geo_dates
}
#include country names and codes
geo_dates %>% 
  mutate(country_code = substr(geo,1,2)) %>% 
  left_join(EU_countries,by="country_code") -> geo_dates
save(geo_dates, file = paste0("./data/region/","geo_dates", ".RData"))

```

funtion to load city data
```{r}
load_data_city <- function(series,alias,dictionary,sheet_names){
  EU_countries<-read_excel("./dictionaries/EU_countries.xlsx") %>% 
  rename(country_code=code,country_name=name)
  #load data
  data <- get_eurostat(series) %>%
    filter(!is.na(values)) %>%  #filter out NAs
    mutate(country_code=substr(cities,1,2)) %>% 
    filter(country_code %in% EU_countries$country_code) %>% 
    filter(nchar(cities)==6) %>% 
    select(-country_code) %>% 
    rename(city_code=cities)
  #recode columns
  for (sheet in sheet_names){

    if (sheet %in% colnames(data)){
        data <- data %>% 
        mutate(!!sym(sheet) := recode(!!sym(sheet), !!!dictionary))
        ##!!! splits a vector into individual arguments for a function
        ## !!sym() is a way to convert the string sheet into a symbol that dplyr can understand as a column name.
    }
  }
  
  save(data, file = paste0("./data/city/",alias, ".RData"))
  print(paste0("series ",series," ", alias, " loaded"))
  rm(data)
  gc()
}

```
load city data
```{r}

statistics<-read_excel("./loading_statistics.xlsx",sheet="city" )

for (ii in 1:nrow(statistics)) {
  load_data_city(statistics$code[ii],statistics$alias[ii],dictionary,sheet_names)
}


```
create geo and time table for the star schema in cities
```{r}
# List all files in the "./data" directory
data_files <- list.files("./data/city")

# Exclude "geo_dates" from the list
data_files <- data_files[data_files != "geo_dates.RData"]

cities<-read_excel("./dictionaries/cities.xlsx" ) %>% 
  rename(city_name=NAME)

geo_dates <- data.frame()
for (file in data_files) {
  load(paste0("./data/city/",file))
  print(file)
  data %>% 
    select(city_code,TIME_PERIOD) %>%
    left_join(cities,by=c("city_code"="CODE")) %>% 
    rbind(geo_dates) %>% 
    unique() ->geo_dates
}
#include country names and codes
geo_dates %>% 
  mutate(country_code = substr(city_code,1,2)) %>% 
  left_join(EU_countries,by="country_code") -> geo_dates
save(geo_dates, file = paste0("./data/city/","geo_dates", ".RData"))

```


NOTE: THESE BELOW ARE OLD LOADS


##1. Material living conditions
Average rating of satisfaction by domain, sex, age and educational attainment level
```{r}
datasets=c("ilc_pw01","ilc_pw05")
EU_countries<-read_excel("./dictionaries/EU_countries.xlsx" ) %>% 
  rename(country_code=code,country_name=name)
EU_Countries_names_dict<- setNames(EU_countries$country_name, EU_countries$country_code)

data_01 <-get_eurostat(datasets[1],
                    filters=list(geo=pull(EU_countries,country_code))) #read data for the 27 only
data_02 <-get_eurostat(datasets[2],
                    filters=list(geo=pull(EU_countries,country_code))) #read data for the 27 only

# merge both datasets
data_01 %>% 
  # mutate(lev_satis=NA ) %>% 
  bind_rows(data_02) -> satisfaction

sheets=c("age","isced11","indic_wb")
for (sheet in sheets) {
  dict <-read_excel(paste0("./dictionaries/","ilc_pw05",".xlsx"),sheet=sheet)
  replacement_dict <- setNames(dict$name, dict$code)
  satisfaction <- satisfaction %>% 
  mutate(!!sym(sheet) := recode(!!sym(sheet), !!!replacement_dict))
  ##!!! splits a vector into individual arguments for a function
  ## !!sym() is a way to convert the string sheet into a symbol that dplyr can understand as a column name.
}

satisfaction %>% 
  mutate(
    sex = recode(sex,"F"="Female","M"="Male","T"="Total"),
    country_name =recode(geo,!!!EU_Countries_names_dict),
    unit = recode(unit,"RTG"="Rating","PC"="Percentage")
    ) %>% 
  rename(indicator=indic_wb,
         education=isced11) -> satisfaction_export

save(exporting_data, file = paste0("./data/","satisfaction", ".RData"))


```

income of households, regional  
```{r}
dataset="nama_10r_2hhinc"
NUTS2<-read_excel("./dictionaries/NUTS2.xlsx" ) %>% 
  rename(geo=NUTS2)

income <-get_eurostat(dataset)
income %>% 
  mutate(country_code=substr(geo,1,2)) %>% 
  filter(country_code %in% EU_countries$country_code) %>% 
  filter(nchar(geo)==4) %>%   #only nuts 2 regions
  filter(direct=="BAL") %>%  #balance
  filter(unit=="EUR_HAB") %>% #eur per habitant
  filter(na_item=="B5N") %>% #income 
  left_join(NUTS2,by="geo") %>% 
  left_join(EU_countries,by=c("country_code")) %>% 
  # mutate(date = TIME_PERIOD) %>% 
  select(-c(direct,na_item)) ->income_export

save(income_export, file = paste0("./data/",dataset, ".RData"))


```


